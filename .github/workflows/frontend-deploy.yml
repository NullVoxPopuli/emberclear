name: Frontend Deploy
on:
  push:
    branches: [master]
    # paths:
    #   - 'packages/frontend/*'

jobs:
  tests:
    name: Tests
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
    - uses: actions/checkout@v1
    - uses: actions/setup-node@v1
      with:
        node-version: '10.x'
    - name: Install
      run: ./run yarn install
    - name: Install Code Coverage Reporter
      env:
        CC_URL: https://codeclimate.com/downloads/test-reporter/test-reporter-latest-linux-amd64
      run: |
        cd packages/frontend
        curl -L $CC_URL > ./cc-test-reporter
        chmod +x ./cc-test-reporter
    - name: Test
      env:
        CC_TEST_REPORTER_ID: ${{ secrets.CC_TEST_REPORTER_ID }}
        PERCY_TOKEN: ${{ secrets.PERCY_TOKEN }}
        COVERAGE: true
        GIT_BRANCH: ${GITHUB_REF}
      run: |
        cd packages/frontend
        ./cc-test-reporter before-build
        time yarn test

        ./cc-test-reporter format-coverage \
          --add-prefix packages/frontend/ \
          --output ./coverage/coverage.json \
          --input-type lcov coverage/lcov.info

        ./cc-test-reporter upload-coverage \
          --input ./coverage/coverage.json

  deploy:
    name: Deploy to Netlify
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs:
    - tests

    steps:
    - uses: actions/checkout@v1
    - uses: actions/setup-node@v1
      with:
        node-version: '10.x'
    - name: Install
      run: ./run yarn install
    - name: Deploy to Netlify
      env:
        FRONTEND: packages/frontend
        NETLIFY_ACCESS_TOKEN: ${{ secrets.NETLIFY_ACCESS_TOKEN }}
        NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }}
        NETLIFY_CLI_VERSION: 0.4.0
        # mv ${FRONTEND}/coverage public/
      run: |
        time ./run yarn analyze
        time ./run yarn build:production
        time ./scripts/publish
    - uses: actions/upload-artifact@master
      with:
        name: frontend-assets
        path: packages/frontend/dist/

  tests_e2e:
    name: E2E Tests
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs:
    - deploy

    steps:
    - uses: actions/checkout@v1
    - uses: actions/setup-node@v1
      with:
        node-version: '10.x'
    - name: Test
      run: |
        cd packages/smoke-tests \
        && yarn \
        && yarn test --headless

  deploy_docker:
    name: Deploy Docker Image
    runs-on: ubuntu-latest
    needs: [tests, deploy]
    timeout-minutes: 5

    steps:
    - uses: actions/checkout@v1
    - uses: actions/download-artifact@master
      with:
        name: frontend-assets
        path: packages/frontend/dist/

    - name: Publish to Registry
      uses: elgohr/Publish-Docker-Github-Action@master
      with:
        name: nullvoxpopuli/emberclear
        username: ${{ secrets.DOCKERHUB_USER }}
        password: ${{ secrets.DOCKERHUB_PASSWORD }}
        snapshot: true
        workdir: packages/frontend
        dockerfile: Dockerfile.release

# Deploy via Script (requires docker environment on VM)
#     - uses: actions/docker/cli@master
#     - name: Publish to DockerHub
#       env:
#         DOCKERHUB_USER: ${{ secrets.DOCKERHUB_USER }}
#         DOCKERHUB_PASSWORD: ${{ secrets.DOCKERHUB_PASSWORD }}
#         # DOCKER_HOST: tcp://docker:2375/
#         # DOCKER_DRIVER: overlay2
#       run: sh ./scripts/dockerhub



